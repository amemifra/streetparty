<script>
    import { onMount } from 'svelte'
    let audio
    let paused = true
    let src = '100 ROSE.m4a';
    // fetch('PAZZESKA.mp3').then(res => res.body).then(sr => {
    //     src = sr
    // });
    //     const ctx = new AudioContext
    //     let destination = ctx.createMediaStreamDestination()
    //     ctx.decodeAudioData('')
    //     ctx.createMediaElementSource(audio)
    onMount(() => {
        // const ctx = new AudioContext
        
        // fetch('PAZZESKA.mp3').then(b => ctx.decodeAudioData(b.arrayBuffer()))
        // ctx.createMediaElementSource(audio)
        // audio.autoplay = true
        // audio.play()
    })

    function playWhen() {
        fetch('/api/when').then(r => r.text()).then(when => {
            const now = Date.now()
            const sec = ~~(now - when / 10) / 100
            if (now > when) {
                src = src + `#t=${sec}`
                console.log('past', sec)
                paused = false;
            } else {
                setTimeout(() => { console.log('future'); paused = false }, (when - now))
            }
            const newTime = Date.now + 8000
            // fetch(`/api/when/${newTime}`).then(r => r.text()).then(r => console.log(r))
        })
    } 
</script>

<h1>Player</h1>

<audio {src} bind:this={audio} bind:paused on:canplaythrough={playWhen()}></audio>